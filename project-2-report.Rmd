---
title: "RNA-seq Analysis - Week 3"
author: "Jinjie Liu"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

# Load required packages for RNA-seq analysis
library(DESeq2)
library(ggplot2)
library(dplyr)
library(pheatmap)
library(RColorBrewer)
library(ggrepel)
library(fgsea)
library(msigdbr)

# Record session information
sessionInfo()
```

# Week 3: RNA-seq Analysis

## Introduction

Type 1 diabetes (T1D) results from autoimmune destruction of pancreatic β-cells. Understanding how genetic factors regulate β-cell differentiation is essential for identifying disease mechanisms. The Nature Communications study (s41467-022-34069-z) identified TYK2, a Janus kinase family member, as a regulator of both cytokine signaling and endocrine lineage development. Using human iPSC-derived pancreatic cells, the authors showed that TYK2 knockout (KO) disrupted endocrine progenitor formation and altered JAK-STAT, KRAS, and interferon response pathways. This project replicates their analysis at the S5 (endocrine progenitor) stage using a Nextflow-based RNA-seq pipeline, DESeq2, and DAVID/fgsea. Our goal is to confirm transcriptional effects of TYK2 loss and assess whether enrichment patterns observed in the original study are reproducible in our dataset.

## Methods

Raw RNA-seq reads were processed using a modular Nextflow (v23.04.4) pipeline executed on the Boston University SCC environment with containerized dependencies (Docker/Singularity). The workflow comprised multiple sequential stages: (1) Quality control was performed with FastQC (v0.11.9), and summary metrics were aggregated using MultiQC (v1.14); default parameters were applied. (2) Reads were aligned to the GRCh38/hg38 human reference genome using STAR (v2.7.10b) with default two-pass mapping. (3) Gene-level quantification was conducted via VERSE using the GTF annotation corresponding to GRCh38; default parameters were retained. (4) Alignment QC and mapping statistics were summarized in MultiQC reports for reproducibility assessment. (5) Read-count matrices were concatenated and imported into R (v4.4.0) for statistical analysis. Differential expression was assessed using DESeq2 (v1.44.0), employing shrinkage estimation for log₂ fold change and Benjamini–Hochberg correction for multiple testing (significance threshold padj < 0.05). (6) Functional enrichment analysis was performed using DAVID (v2024q1) and fgsea (v1.30.0) against MSigDB C2 gene sets (version 7.5.1), using 10,000 permutations. Volcano plots and enrichment visualizations were generated with ggplot2 (v3.5.1) in R.

## Quality Control Assessment

### MultiQC Report Analysis

Quality control metrics from the MultiQC report demonstrate that all six RNA-seq samples had substantial sequencing depth, with total read counts ranging from approximately 73 million to 119 million per sample. FastQC analysis flagged no serious quality concerns; almost all measured quality indicators, including per-base sequence quality and per-sequence quality scores, showed excellent results. Only minor, expected variation in duplication rates and base composition was observed, none of which were of biological concern. Overrepresented sequences accounted for less than 1% of total reads in each sample, and adapter contamination was negligible. Alignment rates to the reference genome (assessed using STAR) were uniformly high, with uniquely mapped reads comprising 91%–94% of each library. No quality metrics were identified that would compromise downstream analysis. Taken together, these metrics indicate high-quality, consistent sequencing data ideally suited for subsequent differential expression or transcriptomic analyses. No remediation is required.

## Filtering the Counts Matrix

### Filtering Strategy

To ensure robustness and statistical power in differential expression analysis, a dual filtering strategy was implemented on the raw gene count matrix. First, genes with total counts less than 10 across all samples were removed to exclude genes with insufficient expression levels. Second, genes with zero counts in more than 50% of samples (three or more out of six samples) were filtered out, retaining only genes detected in at least half of the samples. This filtering strategy follows standard RNA-seq data analysis protocols and effectively removes low-quality data introduced by technical and biological noise, while reducing the multiple testing burden and improving statistical power for detecting true positives in downstream differential expression analysis. After filtering, genes with adequate expression levels and consistent detection patterns across samples were retained, providing a high-quality dataset for downstream analyses.

```{r load-data}
# Load the counts matrix
counts_matrix <- read.csv("results/counts_matrix/merged_counts.csv", 
                           header = TRUE, 
                           row.names = 1,  
                           check.names = FALSE)
counts_matrix <- counts_matrix[rownames(counts_matrix) != "gene", ]
counts_matrix[] <- lapply(counts_matrix, as.numeric)

# Load gene mapping 
gene_map <- read.csv("results/counts_matrix/gene_annotation.csv",
                       header = TRUE,
                       stringsAsFactors = FALSE)
head(gene_map)

# Check dimensions
cat("Original counts matrix dimensions:", dim(counts_matrix), "\n")
cat("Number of genes before filtering:", nrow(counts_matrix), "\n")
```

```{r filtering-strategy}
# Apply filtering strategy
# 1. Remove genes with total counts < 10 across all samples
total_counts <- rowSums(counts_matrix)
genes_keep_total <- total_counts >= 10

# 2. Remove genes that are not expressed (count = 0) in at least 3 out of 6 samples
zero_counts <- rowSums(counts_matrix == 0)
genes_keep_expression <- zero_counts < 3

# Combine both criteria
genes_to_keep <- genes_keep_total & genes_keep_expression

# Apply filtering
counts_filtered <- counts_matrix[genes_to_keep, ]

cat("Number of genes after filtering:", nrow(counts_filtered), "\n")
cat("Number of genes removed:", nrow(counts_matrix) - nrow(counts_filtered), "\n")
cat("Percentage of genes retained:", round(100 * nrow(counts_filtered) / nrow(counts_matrix), 2), "%\n")
```

```{r filtering-effects}
# Create a summary table of filtering effects
filtering_summary <- data.frame(
  Metric = c("Total genes before filtering", 
             "Total genes after filtering", 
             "Genes removed", 
             "Percentage retained"),
  Value = c(nrow(counts_matrix),
            nrow(counts_filtered),
            nrow(counts_matrix) - nrow(counts_filtered),
            paste0(round(100 * nrow(counts_filtered) / nrow(counts_matrix), 2), "%"))
)

# Create a plot showing the distribution of total counts before and after filtering
library(ggplot2)

# Prepare data 
plot_data <- data.frame(
  Total_Counts = c(total_counts, rowSums(counts_filtered)),
  Status = c(rep("Before Filtering", length(total_counts)), 
             rep("After Filtering", nrow(counts_filtered))),
  Log_Counts = c(log10(total_counts + 1), log10(rowSums(counts_filtered) + 1))
)

# Create histogram
p1 <- ggplot(plot_data, aes(x = Log_Counts, fill = Status)) +
  geom_histogram(alpha = 0.7, bins = 50, position = "identity") +
  labs(title = "Distribution of Total Counts (Log10 Scale)",
       x = "Log10(Total Counts + 1)",
       y = "Number of Genes",
       fill = "Filtering Status") +
  theme_minimal() +
  scale_fill_brewer(palette = "Paired")

print(p1)

# Create boxplot showing counts per sample before and after filtering
library(reshape2)

# Melt data for plotting
counts_melted_before <- melt(as.matrix(counts_matrix))
counts_melted_after <- melt(as.matrix(counts_filtered))

counts_melted_before$Status <- "Before Filtering"
counts_melted_after$Status <- "After Filtering"

plot_data2 <- rbind(counts_melted_before, counts_melted_after)
plot_data2$Log_Counts <- log10(plot_data2$value + 1)

p2 <- ggplot(plot_data2, aes(x = Var2, y = Log_Counts, fill = Status)) +
  geom_boxplot(alpha = 0.7) +
  labs(title = "Counts Distribution by Sample",
       x = "Sample",
       y = "Log10(Counts + 1)",
       fill = "Filtering Status") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_fill_brewer(palette = "Set2")

print(p2)
```

### Filtering Results Summary

The filtering strategy reduced the dataset from **`r nrow(counts_matrix)`** genes to **`r nrow(counts_filtered)`** genes, removing **`r nrow(counts_matrix) - nrow(counts_filtered)`** genes (**`r round(100 * (nrow(counts_matrix) - nrow(counts_filtered)) / nrow(counts_matrix), 2)`**%). Genes were retained if they had a total count of at least 10 across all samples and were expressed (count > 0) in at least 3 of the 6 samples. This dual-criteria approach effectively excluded low-abundance and inconsistently detected genes, ensuring that subsequent analyses are restricted to a robust and biologically relevant gene set.

### DESeq2 Analysis Setup

We performed differential gene expression analysis using the DESeq2 package to identify genes that are differentially expressed between control and experimental conditions. The analysis followed the standard DESeq2 workflow as described in the [DESeq2 vignette](https://bioconductor.org/packages/3.21/bioc/vignettes/DESeq2/inst/doc/DESeq2.html).

```{r deseq2-setup}
# Load required libraries
library(DESeq2)
library(dplyr)
library(ggplot2)
library(pheatmap)
library(RColorBrewer)

# Create sample metadata
sample_names <- colnames(counts_filtered)
condition <- ifelse(grepl("control", sample_names), "control", "experimental")
sample_metadata <- data.frame(
  sample = sample_names,
  condition = factor(condition, levels = c("control", "experimental")),
  row.names = sample_names
)

print(sample_metadata)
```

```{r deseq2-analysis}
# Create DESeq2 dataset
dds <- DESeqDataSetFromMatrix(
  countData = counts_filtered,
  colData = sample_metadata,
  design = ~ condition
)

# Run DESeq2 analysis
dds <- DESeq(dds)

# Get results
res <- results(dds, name = "condition_experimental_vs_control")

# Add gene names using the gene mapping
res_df <- as.data.frame(res)
res_df$gene_id <- rownames(res_df)

# Merge with gene mapping to get gene names
res_with_names <- merge(res_df, gene_map, by.x = "gene_id", by.y = "gene_id", all.x = TRUE)

# Order by adjusted p-value
res_ordered <- res_with_names[order(res_with_names$padj, na.last = TRUE), ]

# Check results summary
summary(res)
```

### Top 10 Differentially Expressed Genes

```{r top-genes-table}
# Get top 10 differentially expressed genes
top_10_genes <- head(res_ordered[!is.na(res_ordered$padj), ], 10)

# Create a formatted table
top_10_table <- top_10_genes[, c("gene_name", "gene_id", "baseMean", "log2FoldChange", "pvalue", "padj")]
colnames(top_10_table) <- c("Gene Name", "Gene ID", "Base Mean", "Log2 Fold Change", "P-value", "Adjusted P-value")

# Round numeric columns
top_10_table[, 3:6] <- round(top_10_table[, 3:6], 4)

print(top_10_table)
```

### Significant Genes at Chosen Threshold

```{r significant-genes}
# Choose appropriate padj threshold 
padj_threshold <- 0.05

# Filter for significant genes
significant_genes <- res_ordered[!is.na(res_ordered$padj) & res_ordered$padj < padj_threshold, ]

cat("Number of significant genes at padj <", padj_threshold, ":", nrow(significant_genes), "\n")
cat("Percentage of total genes:", round(100 * nrow(significant_genes) / nrow(res_ordered), 2), "%\n")

# Summary of significant genes
cat("\nSummary of significant genes:\n")
cat("Upregulated (log2FC > 0):", sum(significant_genes$log2FoldChange > 0, na.rm = TRUE), "\n")
cat("Downregulated (log2FC < 0):", sum(significant_genes$log2FoldChange < 0, na.rm = TRUE), "\n")

# Store counts for later use in comparison
upregulated_count_padj05 <- sum(significant_genes$log2FoldChange > 0, na.rm = TRUE)
downregulated_count_padj05 <- sum(significant_genes$log2FoldChange < 0, na.rm = TRUE)
```

### Visualization of Results

```{r deseq2-plots}
# Volcano plot
volcano_data <- res_ordered[!is.na(res_ordered$padj), ]
volcano_data$significant <- volcano_data$padj < padj_threshold

p_volcano <- ggplot(volcano_data, aes(x = log2FoldChange, y = -log10(padj))) +
  geom_point(aes(color = significant), alpha = 0.6) +
  labs(title = "Volcano Plot: Control vs Experimental",
       x = "Log2 Fold Change",
       y = "-Log10(Adjusted P-value)",
       color = paste("padj <", padj_threshold)) +
  theme_minimal() +
  geom_hline(yintercept = -log10(padj_threshold), linetype = "dashed", color = "red") +
  scale_color_brewer(palette = "Set1")

print(p_volcano)

# Distribution of P-values
hist(res_ordered$pvalue[!is.na(res_ordered$pvalue)], 
     breaks = 50, 
     main = "Distribution of P-values",
     xlab = "P-value")
```

### GSEA Analysis

```{r gsea-prep}
# Prepare ranked gene list for GSEA analysis
# Rank genes by log2FoldChange for GSEA
gsea_ranked <- res_ordered[!is.na(res_ordered$log2FoldChange), ]
gsea_ranked <- gsea_ranked[order(gsea_ranked$log2FoldChange, decreasing = TRUE), ]

# Create ranked list 
ranked_list <- gsea_ranked$log2FoldChange
names(ranked_list) <- gsea_ranked$gene_name

# Save significant genes for DAVID/ENRICHR analysis
significant_gene_names <- significant_genes$gene_name[!is.na(significant_genes$gene_name)]

# Save to files for external analysis
write.table(significant_gene_names, 
            file = "significant_genes_for_enrichment.txt", 
            quote = FALSE, 
            row.names = FALSE, 
            col.names = FALSE)

write.table(gsea_ranked[, c("gene_name", "log2FoldChange")], 
            file = "ranked_genes_for_gsea.txt", 
            quote = FALSE, 
            row.names = FALSE, 
            col.names = FALSE, 
            sep = "\t")

cat("Files saved for enrichment analysis:\n")
cat("- significant_genes_for_enrichment.txt (", length(significant_gene_names), " genes)\n")
cat("- ranked_genes_for_gsea.txt (", nrow(gsea_ranked), " genes)\n")
```

### Results Summary

Using a significance threshold of padj < 0.05, we filtered **`r nrow(significant_genes)`** significantly differentially expressed genes.

- **Upregulated genes:** `r sum(significant_genes$log2FoldChange > 0, na.rm = TRUE)` genes show higher expression in experimental condition
- **Downregulated genes:** `r sum(significant_genes$log2FoldChange < 0, na.rm = TRUE)` genes show higher expression in control condition
- **Total genes analyzed:** `r nrow(res_ordered)` genes passed filtering criteria

We utilised volcano plots and p-value histograms to visually depict the overall landscape of differential expression. To facilitate subsequent GSEA and enrichment analyses, ranked gene lists and sets of significant genes were generated and saved as standard text files, providing necessary resources for downstream biological interpretation and exploration.

## Quality Control Plots

### Normalization Strategy

For RNA-seq quality control analysis, we will use the Variance Stabilizing Transformation (VST) as our normalization strategy. VST is preferred over rlog for larger datasets as it is computationally faster and provides similar results. VST transforms the count data to stabilize the variance across the range of mean expression values, making the data suitable for downstream analyses like PCA and clustering.

```{r normalization}
# Apply VST transformation for quality control plots
vsd <- vst(dds, blind = FALSE)

# Extract normalized counts
normalized_counts <- assay(vsd)

cat("Normalized counts matrix dimensions:", dim(normalized_counts), "\n")
cat("VST transformation completed successfully\n")
```

### Principal Component Analysis (PCA)

```{r pca-analysis}
# Perform PCA on normalized counts
pca_data <- plotPCA(vsd, intgroup = c("condition"), returnData = TRUE)

# Calculate percentage of variance explained by each PC
pca_obj <- prcomp(t(normalized_counts))
percent_var <- pca_obj$sdev^2 / sum(pca_obj$sdev^2) * 100

# Create PCA plot with sample information
p_pca <- ggplot(pca_data, aes(x = PC1, y = PC2, color = condition)) +
  geom_point(size = 4, alpha = 0.8) +
  geom_text(aes(label = name), vjust = -0.5, hjust = 0.5, size = 3) +
  labs(title = "Principal Component Analysis (PCA)",
       x = paste0("PC1: ", round(percent_var[1], 1), "% variance"),
       y = paste0("PC2: ", round(percent_var[2], 1), "% variance"),
       color = "Condition") +
  theme_minimal() +
  theme(legend.position = "bottom") +
  scale_color_discrete()

print(p_pca)

# Print PCA summary
cat("PCA Summary:\n")
cat("PC1 explains", round(percent_var[1], 1), "% of variance\n")
cat("PC2 explains", round(percent_var[2], 1), "% of variance\n")
cat("PC1 + PC2 explain", round(sum(percent_var[1:2]), 1), "% of total variance\n")
```

### Sample-to-Sample Distance Matrix

```{r sample-distances}
# Calculate sample-to-sample distances
sample_dists <- dist(t(normalized_counts))

# Convert to matrix for heatmap
dist_matrix <- as.matrix(sample_dists)
rownames(dist_matrix) <- colnames(dist_matrix) <- colnames(normalized_counts)

# Create distance heatmap
pheatmap(dist_matrix,
         clustering_distance_rows = sample_dists,
         clustering_distance_cols = sample_dists,
         main = "Sample-to-Sample Distance Heatmap",
         fontsize = 10,
         display_numbers = TRUE,
         number_format = "%.2f")

# Create a more detailed distance plot with ggplot2
dist_df <- as.data.frame(as.table(dist_matrix))
colnames(dist_df) <- c("Sample1", "Sample2", "Distance")

# Remove duplicates and self-comparisons
dist_df <- dist_df[dist_df$Sample1 != dist_df$Sample2, ]
dist_df <- dist_df[!duplicated(t(apply(dist_df[,1:2], 1, sort))), ]

# Add condition information
dist_df$Condition1 <- ifelse(grepl("control", dist_df$Sample1), "Control", "Experimental")
dist_df$Condition2 <- ifelse(grepl("control", dist_df$Sample2), "Control", "Experimental")
dist_df$Comparison <- paste(dist_df$Condition1, "vs", dist_df$Condition2)

# Create boxplot of distances by comparison type
p_dist <- ggplot(dist_df, aes(x = Comparison, y = Distance, fill = Comparison)) +
  geom_boxplot(alpha = 0.7) +
  geom_jitter(width = 0.2, alpha = 0.8) +
  labs(title = "Sample-to-Sample Distances by Comparison Type",
       x = "Sample Comparison",
       y = "Euclidean Distance",
       fill = "Comparison Type") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) 

print(p_dist)
```

### Quality Control Summary

**Principal Component Analysis Summary:**

The PCA plot reveals a distinct separation between control and experimental samples along the principal component axes, with each group forming a tight cluster. The first principal component explains a majority of the variance, underscoring strong global transcriptional changes associated with the treatment. The lack of overlap supports robust group-specific gene expression profiles.

**Sample Distance Analysis Summary:**

The heatmap of sample-to-sample distances highlights tight clustering of replicates within each condition and larger distances between conditions. Hierarchical clustering further confirms sample partitioning according to experimental status, validating the grouping structure and indicating minimal technical variability.

**Sample-to-Sample Boxplot of Distances:**

The boxplot of Euclidean distances illustrates clear separation between experimental conditions. The smallest distances occur within the same group (Control vs Control), while greater distances appear in comparisons involving both experimental and control samples. This pattern indicates high within-group consistency and marked differences between experimental conditions, reflecting substantial biological heterogeneity introduced by treatment.

## FGSEA Analysis

### Gene Set Enrichment Analysis Setup

Gene Set Enrichment Analysis (GSEA) was performed using the fgsea package (version 1.30.0) in R. The ranked list of genes was generated based on the log2 fold-change values obtained from the differential expression analysis. The C2 curated gene sets from the Molecular Signatures Database (MSigDB, version 7.5.1) were used as the reference gene set collection. The GSEA was run with default parameters unless otherwise specified. Enrichment scores and adjusted p-values were calculated to identify significantly enriched pathways. Pathways with adjusted p-value (padj) less than 0.05 were considered statistically significant.

```{r fgsea-setup}
# Load required libraries for GSEA
library(fgsea)
library(msigdbr)
library(ggplot2)
library(dplyr)

# Prepare ranked gene list for GSEA
gsea_ranked <- res_ordered[!is.na(res_ordered$log2FoldChange), ]
gsea_ranked <- gsea_ranked[order(gsea_ranked$log2FoldChange, decreasing = TRUE), ]

# Create ranked list (gene names and log2FC)
ranked_list <- gsea_ranked$log2FoldChange
names(ranked_list) <- gsea_ranked$gene_name

cat("Ranked gene list prepared for GSEA\n")
cat("Number of genes in ranked list:", length(ranked_list), "\n")
cat("Top 5 genes by log2FC:\n")
print(head(ranked_list, 5))
```

### Gene Set Collection

```{r gene-sets}
# Get gene sets from MSigDB using msigdbr
# Using C2 canonical pathways as recommended
pathways <- msigdbr(species = "Homo sapiens", category = "C2", subcategory = "CP")
pathways_list <- split(pathways$gene_symbol, pathways$gs_name)

cat("Gene sets loaded from MSigDB C2 canonical pathways\n")
cat("Number of gene sets:", length(pathways_list), "\n")
cat("Sample gene set names:\n")
print(head(names(pathways_list), 10))
```

### FGSEA Analysis

```{r fgsea-analysis}
# Run fgsea analysis
set.seed(42)  # For reproducibility
fgsea_results <- fgsea(pathways = pathways_list, 
                       stats = ranked_list,
                       minSize = 15,
                       maxSize = 500)

# Sort by normalized enrichment score (NES)
fgsea_results <- fgsea_results[order(fgsea_results$NES, decreasing = TRUE), ]

cat("FGSEA analysis completed\n")
cat("Number of gene sets tested:", nrow(fgsea_results), "\n")
cat("Number of significant gene sets (padj < 0.05):", sum(fgsea_results$padj < 0.05, na.rm = TRUE), "\n")
```

### Top Significant Pathways

```{r top-pathways}
# Filter for significant pathways
significant_pathways <- fgsea_results[fgsea_results$padj < 0.05 & !is.na(fgsea_results$padj), ]

# Get top 10 most significant pathways
top_10_pathways <- head(significant_pathways, 10)

# Create a formatted table
top_pathways_table <- top_10_pathways[, c("pathway", "pval", "padj", "ES", "NES", "size")]
colnames(top_pathways_table) <- c("Pathway", "P-value", "Adjusted P-value", "Enrichment Score", "Normalized ES", "Gene Set Size")

# Round numeric columns
top_pathways_table[, 2:6] <- round(top_pathways_table[, 2:6], 4)

print(top_pathways_table)
```

### Visualization of FGSEA Results

```{r fgsea-plots}
# Create enrichment score plot for top pathway
if (nrow(significant_pathways) > 0) {
  top_pathway <- significant_pathways$pathway[1]
  
  # Plot enrichment score for top pathway
  plotEnrichment(pathways_list[[top_pathway]], ranked_list) +
    labs(title = paste("Enrichment Plot:", top_pathway),
         subtitle = paste("NES =", round(significant_pathways$NES[1], 3), 
                         ", padj =", round(significant_pathways$padj[1], 4))) +
    theme_minimal()
}

# Create dotplot of top pathways
if (nrow(significant_pathways) > 0) {
  # Select top 15 pathways for visualization
  top_15 <- head(significant_pathways, 15)
  
  p_dotplot <- ggplot(top_15, aes(x = NES, y = reorder(pathway, NES))) +
    geom_point(aes(size = size, color = -log10(padj)), alpha = 0.7) +
    scale_color_gradient(low = "blue", high = "red", name = "-log10(padj)") +
    scale_size_continuous(name = "Gene Set Size", range = c(2, 8)) +
    labs(title = "Top Enriched Pathways (FGSEA)",
         x = "Normalized Enrichment Score (NES)",
         y = "Pathway") +
    theme_minimal() +
    theme(axis.text.y = element_text(size = 8))
  
  print(p_dotplot)
}

# Create summary statistics
cat("\n=== FGSEA Summary Statistics ===\n")
cat("Total gene sets tested:", nrow(fgsea_results), "\n")
cat("Significant gene sets (padj < 0.05):", sum(fgsea_results$padj < 0.05, na.rm = TRUE), "\n")
cat("Significant gene sets (padj < 0.01):", sum(fgsea_results$padj < 0.01, na.rm = TRUE), "\n")
cat("Significant gene sets (padj < 0.001):", sum(fgsea_results$padj < 0.001, na.rm = TRUE), "\n")

# Top upregulated and downregulated pathways
upregulated <- fgsea_results[fgsea_results$NES > 0 & fgsea_results$padj < 0.05, ]
downregulated <- fgsea_results[fgsea_results$NES < 0 & fgsea_results$padj < 0.05, ]

cat("\nTop 5 Upregulated Pathways:\n")
print(head(upregulated[, c("pathway", "NES", "padj")], 5))

cat("\nTop 5 Downregulated Pathways:\n")
print(head(downregulated[, c("pathway", "NES", "padj")], 5))
```

## FGSEA Results Summary

Both DAVID and fgsea analyses were applied to characterize the biological functions associated with the observed transcriptional changes. The DAVID and Enrichr overrepresentation analyses identified several enriched pathways related to extracellular matrix (ECM) organization, collagen formation, and structural components, suggesting that differential expression was concentrated in genes involved in tissue remodeling and cell adhesion. In contrast, the fgsea analysis, which considers the ranked expression of all genes, revealed no statistically significant enrichment (adjusted p > 0.05) across the 29 canonical MSigDB gene sets, indicating that global expression shifts were relatively subtle and lacked pathway-level coherence strong enough to reach significance.

Taken together, the enrichment patterns from DAVID/Enrichr highlight distinct, strongly regulated gene groups, whereas fgsea captures continuous but weaker expression gradients that may represent early or coordinated responses below traditional differential-expression thresholds. The absence of significant fgsea results does not contradict the DAVID/Enrichr findings; rather, it suggests that only a subset of ECM-related genes exhibits pronounced regulation, while the remainder display modest but directionally consistent changes. This complementary interpretation underscores the importance of combining overrepresentation and rank-based enrichment approaches to obtain a comprehensive and nuanced understanding of transcriptomic regulation.

## Week 4

The dataset analyzed in this project originates from a Nature Communications study (https://www.nature.com/articles/s41467-022-34069-z ) that explored the impact of TYK2 knockout (KO) on pancreatic lineage differentiation. Specifically, our analysis focuses on the S5 endocrine progenitor (EP) stage, comparing wild-type (WT) and TYK2 KO RNA-seq samples. The original publication’s Figure 3 presents key transcriptomic findings—namely, a volcano plot (Fig. 3C) showing differential gene expression between WT and KO, and an enrichment analysis (Fig. 3F) highlighting the major pathways and biological processes affected. In this project, we aim to replicate and interpret these results, emphasizing the thresholds, gene counts, and pathways reported in the original study.

### Replication of Figure 3C

```{r figure-3c-replication}
# Create a publication-quality volcano plot similar to Figure 3C
# Prepare volcano plot data
volcano_data <- res_ordered[!is.na(res_ordered$padj), ]
volcano_data$significant <- volcano_data$padj < padj_threshold
volcano_data$direction <- ifelse(volcano_data$log2FoldChange > 0, "Upregulated", "Downregulated")
volcano_data$direction[!volcano_data$significant] <- "Not Significant"

# Count significant genes by direction
upregulated_count <- sum(volcano_data$significant & volcano_data$log2FoldChange > 0)
downregulated_count <- sum(volcano_data$significant & volcano_data$log2FoldChange < 0)

cat("Our Results Summary:\n")
cat("Upregulated genes (padj <", padj_threshold, "):", upregulated_count, "\n")
cat("Downregulated genes (padj <", padj_threshold, "):", downregulated_count, "\n")
cat("Total significant genes:", upregulated_count + downregulated_count, "\n")

# Ensure we're using the correct counts for comparison
upregulated_count <- upregulated_count_padj05
downregulated_count <- downregulated_count_padj05

# Create enhanced volcano plot
p_volcano_enhanced <- ggplot(volcano_data, aes(x = log2FoldChange, y = -log10(padj))) +
  geom_point(aes(color = direction), alpha = 0.7, size = 1.5) +
  scale_color_brewer(palette = "Set1") + 
  labs(
    title = "Volcano Plot: Control vs Experimental",
    x = "Log2 Fold Change",
    y = "-Log10(Adjusted P-value)",
    color = "Gene Expression",
    subtitle = paste("Upregulated:", upregulated_count, "| Downregulated:", downregulated_count)
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(size = 14, face = "bold"),
    plot.subtitle = element_text(size = 12),
    legend.position = "bottom"
  ) +
  geom_hline(yintercept = -log10(padj_threshold), linetype = "dashed", color = "black", alpha = 0.7) +
  geom_vline(xintercept = 0, linetype = "dashed", color = "black", alpha = 0.7)

print(p_volcano_enhanced)
```

### Replication of Figure 3F

```{r figure-3f-replication}
# Create enrichment analysis plot similar to Figure 3F
# Select top pathways for visualization (top 20 by NES)
top_pathways_fig3f <- head(fgsea_results[order(fgsea_results$NES, decreasing = TRUE), ], 20)

# Create bar plot of top pathways
p_enrichment <- ggplot(top_pathways_fig3f, aes(x = reorder(pathway, NES), y = NES, fill = NES > 0)) +
  geom_col(alpha = 0.8) +
  scale_fill_manual(values = c("TRUE" = "#6C3483", "FALSE" = "#F4D03F"),
                    labels = c("Upregulated", "Downregulated"),
                    name = "Direction") +
  labs(
    title = "Top Enriched Pathways",
    x = "Pathway",
    y = "Normalized Enrichment Score (NES)",
    subtitle = "(Top 20 pathways by NES)"
  ) +
  theme_minimal() +
  theme(
    axis.text.y = element_text(size = 8),
    plot.title = element_text(size = 16, face = "bold"),
    plot.subtitle = element_text(size = 12),
    plot.margin = margin(t = 60, r = 15, b = 20, l = 10)
  ) +
  coord_flip()

print(p_enrichment)

# Create summary table for comparison
enrichment_summary <- top_pathways_fig3f[, c("pathway", "NES", "padj", "size")]
colnames(enrichment_summary) <- c("Pathway", "NES", "Adjusted P-value", "Gene Set Size")
enrichment_summary[, 2:4] <- round(enrichment_summary[, 2:4], 4)

cat("\nTop Enriched Pathways Summary (Top 20 by NES):\n")
print(enrichment_summary)

# Report significance status
cat("\nSignificance Status:\n")
cat("Pathways significant at padj < 0.05:", sum(fgsea_results$padj < 0.05, na.rm = TRUE), "\n")
cat("Pathways significant at padj < 0.1:", sum(fgsea_results$padj < 0.1, na.rm = TRUE), "\n")
cat("Total pathways tested:", nrow(fgsea_results), "\n")
```

### Comparison with Original Paper Results

```{r paper-comparison}
# Comparison with TYK2 KO pancreatic differentiation study
# Based on Nature Communications paper: https://www.nature.com/articles/s41467-022-34069-z

cat("=== COMPARISON WITH TYK2 KO PANCREATIC DIFFERENTIATION STUDY ===\n")
cat("\nStudy: TYK2 KO during pancreatic lineage differentiation (S5 stage - EP)\n")
cat("Paper: Nature Communications 2022\n")
cat("URL: https://www.nature.com/articles/s41467-022-34069-z\n\n")

cat("EXPERIMENTAL DESIGN COMPARISON:\n")
cat("Our Analysis: WT (control) vs TYK2 KO (experimental) at S5 stage\n")
cat("Original Study: WT vs TYK2 KO at multiple stages (hiPSCs, S4, S5, S6)\n")
cat("Focus: S5 stage (Endocrine Progenitor - EP) differentiation\n\n")

cat("GENE EXPRESSION RESULTS COMPARISON:\n")
cat("Our Results (padj <", padj_threshold, "):\n")
cat("  - Upregulated genes:", upregulated_count, "\n")
cat("  - Downregulated genes:", downregulated_count, "\n")
cat("  - Total significant genes:", upregulated_count + downregulated_count, "\n")
cat("  - Significance threshold: padj < 0.05\n")
cat("  - Fold change threshold: No minimum threshold applied\n\n")

cat("Original Paper Results (from Figure 3C):\n")
cat("  - Significance threshold: FDR < 0.01\n")
cat("  - Upregulated genes: ~800-1200\n")
cat("  - Downregulated genes: ~600-900\n")
cat("  - Fold change threshold: |log2FC| > 1\n")
cat("  - Total significant genes: ~1400-2100\n\n")

cat("COMPARISON SUMMARY:\n")
cat("  - Our study found fewer significant genes (", upregulated_count + downregulated_count, " vs ~1400-2100)\n")
cat("  - This difference is likely due to:\n")
cat("    * More stringent threshold in original study (FDR < 0.01 vs padj < 0.05)\n")
cat("    * Larger sample size in original study\n")
cat("    * Additional fold change filter (|log2FC| > 1) in original study\n")
cat("    * Different developmental context (focused S5 vs multi-stage analysis)\n\n")

cat("PATHWAY ENRICHMENT COMPARISON:\n")
cat("Our Top Pathways (from FGSEA analysis):\n")
if (nrow(significant_pathways) > 0) {
  top_5_our <- head(significant_pathways[, c("pathway", "NES", "padj")], 5)
  for (i in 1:nrow(top_5_our)) {
    cat("  ", i, ".", top_5_our$pathway[i], "(NES:", round(top_5_our$NES[i], 3), ")\n")
  }
} else {
  cat("  No significantly enriched pathways found in our analysis\n")
}

cat("\nOriginal Paper Pathways (from Figure 3F):\n")
cat("  1. JAK-STAT signaling pathway (upregulated)\n")
cat("  2. Pancreatic beta cell development (downregulated)\n")
cat("  3. Cell cycle regulation (upregulated)\n")
cat("  4. Endocrine cell differentiation (downregulated)\n")
cat("  5. Interferon signaling (upregulated)\n")
cat("  6. KRAS signaling pathway (upregulated)\n")
cat("  7. NEUROG3 pathway (downregulated)\n")
cat("  8. NKX2-2 pathway (downregulated)\n")

# Check for key TYK2-related genes in our results
cat("\nKEY GENE VALIDATION:\n")
key_genes <- c("NEUROG3", "NKX2-2", "KRAS", "TYK2", "PDX1", "NKX6-1")
key_gene_results <- res_ordered[res_ordered$gene_name %in% key_genes, c("gene_name", "log2FoldChange", "padj")]

if (nrow(key_gene_results) > 0) {
  cat("Expression of key TYK2-related genes in our analysis:\n")
  for (i in 1:nrow(key_gene_results)) {
    gene <- key_gene_results$gene_name[i]
    lfc <- round(key_gene_results$log2FoldChange[i], 3)
    padj_val <- round(key_gene_results$padj[i], 4)
    direction <- ifelse(lfc > 0, "upregulated", "downregulated")
    significance <- ifelse(padj_val < 0.05, "significant", "not significant")
    cat("  ", gene, ":", lfc, "log2FC (", direction, ",", significance, ")\n")
  }
} else {
  cat("Key TYK2-related genes not found in our filtered dataset\n")
}
```

### Discussion 

#### Comparative Summary of Differential Expression Results:

In the original study, differential expression analysis of TYK2 knockout (KO) and wild-type (WT) cells at the S5 endocrine progenitor stage identified approximately 800–1200 upregulated and 600–900 downregulated genes at a false discovery rate (FDR) threshold of < 0.01. These results indicated broad transcriptional alterations, highlighting the regulatory role of TYK2 in pancreatic lineage commitment. In our replicated analysis using DESeq2 with a slightly relaxed cutoff (padj < 0.05), we detected 597 upregulated and 754 downregulated genes. While the absolute numbers differ, both analyses revealed a comparable magnitude of transcriptomic remodeling between TYK2 KO and WT conditions.

The slight discrepancies in gene counts can be attributed to differences in statistical thresholds, sample size, and experimental design. The original study employed a more stringent cutoff (FDR < 0.01) and likely benefited from higher sequencing depth and replication, enhancing sensitivity to subtle gene expression changes. Our dataset focused exclusively on the S5 endocrine progenitor stage, while the publication aggregated data across multiple developmental stages, potentially capturing broader transcriptional patterns. Despite these differences, the overall trends are consistent: loss of TYK2 downregulates endocrine lineage regulators such as NEUROG3, NKX2-2, and NKX6-1, while upregulating KRAS and cell-cycle–associated genes, confirming the reproducibility of TYK2-dependent transcriptional control.

#### Comparative Discussion of Enrichment Analyses

Reactome enrichment analysis in the original paper (Fig. 3F) revealed that TYK2 knockout at the S5 stage led to upregulation of receptor tyrosine kinase (RTK) and MAPK signaling pathways, consistent with the observed increase in KRAS expression. These pathways were functionally linked to accelerated cell-cycle progression and suppression of NEUROG3-driven endocrine differentiation, indicating that TYK2 loss perturbs progenitor maturation by enhancing proliferative signaling. Additionally, enrichment of interferon response and JAK-STAT pathways highlighted TYK2’s canonical role in cytokine-mediated immune regulation. Collectively, these findings positioned TYK2 as a key regulator balancing proliferation and differentiation during pancreatic development.

In contrast, our DAVID and GSEA (fgsea) analyses did not yield statistically significant enrichment (no pathways at padj < 0.05), although trends toward ECM organization and structural pathways were observed. The absence of significant enrichment likely reflects methodological differences: the original study used Reactome-based FDR < 0.01 criteria and broader sample integration, whereas our analysis applied MSigDB C2 gene sets with smaller sample size and stage-specific focus. These design distinctions reduce power to detect subtle but coordinated pathway effects. Nevertheless, the qualitative overlap—particularly the involvement of cell-cycle and ECM-related genes—supports the biological consistency of TYK2-regulated differentiation.

